<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style type="text/css">
        * {
            margin: 0%;
            padding: 0%;
        }

        .main {
            width: 100vw;
            height: 100vh;
        }

        .btnBox {
            width: 100%;
            height: 3rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .btnBox button {
            height: 40px;
            line-height: 40px;
            width: auto;
            padding: 0 15px;
            background: #ccc;
            border: none;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .video-box {
            background: #000;
            position: relative;
            width: 100%;
            height: calc(100% - 5rem);
            overflow: hidden;
            display: flex;
            flex-flow: wrap;
            align-content: flex-start;
        }

        .video {
            width: 20%;
            height: 20%;
            border: 1px solid #fff;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="main">
        <div class="btnBox">
            <button type="button" onclick="startMedia()">开启本机摄像和音频</button>
            <button type="button" onclick="startConnect()">建立连接</button>
            <button type="button" id="addDeviceStream">添加设备流</button>
            <button type="button" id="addDesktopStream">添加桌面流</button>
        </div>
        <div class="video-box">
            <div class="video local-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
            <div class=" video remote-video">
                <video autoplay></video>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const userId = String(Math.round(Math.random() * 10000))
        const socketUrl = `ws://localhost:8080/msgServer/${userId}`
        let socket
        let peerConnected = false, peerConnection = null

        const localVideo = document.querySelector('.local-video video');
        const remoteVideos = document.querySelectorAll('.remote-video');
        let remoteNum = 0

        let localStream = null, desktopStream = null

        window.onload = () => {
            socket = new WebSocket(socketUrl)
            socket.onopen = () => {
                console.log("成功连接至WebSocket服务器");
            }

            socket.onclose = (err) => {
                console.log(`与服务器断开连接: `);
                console.log(err);
            }

            socket.onmessage = (msg) => {
                console.log('接到来自WebSocket的消息');
                const evt = JSON.parse(msg.data)
                console.log(evt);
                if (evt.type === 'offer') {
                    console.log("接收到offer,设置offer,发送answer....")
                    setOffer(evt)
                } else if (evt.type === 'answer' && peerConnected) {
                    console.log('接收到answer,设置answer SDP');
                    setAnswer(evt);
                } else if (evt.type === 'candidate' && peerConnected) {
                    console.log('接收到ICE候选者..');
                    setCandidate(evt);
                } else if (evt.type === 'bye' && peerConnected) {
                    console.log("WebRTC通信断开");
                    stop();
                }
            }
        }

        function startMedia() {
            navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            }).then((stream) => {
                for (const track of stream.getTracks()) {
                    track.enabled = false
                }
                console.log(stream.getTracks());
                localStream = stream
                localVideo.srcObject = localStream
                localVideo.play()
                localVideo.volume = 0;
            }).catch((err) => {
                console.error(`捕获本地媒体时发生了一个错误：${err.message}`);
            })

            navigator.mediaDevices.getDisplayMedia().then((displayStream) => {
                desktopStream = displayStream
            })
        }

        function startConnect() {
            if (!localStream) {
                alert('请先捕获本地媒体流')
            } else if (socket.readyState !== WebSocket.OPEN) {
                alert('请刷新页面')
                location.reload()
            } else {
                sendOffer()
                peerConnected = true
            }
        }

        function sendOffer() {
            peerConnection = prepareNewConnection()

            peerConnection.createOffer({
                'mandatory': {
                    'OfferToReceiveAudio': false, // 如果该值为false，即使本地端将发送音频数据，也不会提供远程端点发送音频数据。 如果此值为true，即使本地端不会发送音频数据，也将向远程端点发送音频数据。默认行为是仅在本地发送音频时才提供接收音频，否则不提供。
                    'OfferToReceiveVideo': true
                }
            }).then((sessionDescription) => {
                peerConnection.setLocalDescription(sessionDescription)
                console.log('启动一个新的WebRTC去连接远程端点');
                sendSDP(sessionDescription)
            }).catch((err) => {
                console.error(`创建Offer失败：${err.message}`);
            })
        }

        function setOffer(evt) {
            if (peerConnection) {
                console.warn('已存在PeerConnection');
                return
            }
            peerConnection = prepareNewConnection()

            peerConnection.setRemoteDescription(new RTCSessionDescription(evt))

            console.log('发送Answer,创建远程会话描述...');
            if (!peerConnection) {
                console.error('peerConnection不存在!');
                return;
            }
            peerConnection.createAnswer({
                'mandatory': {
                    'OfferToReceiveAudio': false, // 如果该值为false，即使本地端将发送音频数据，也不会提供远程端点发送音频数据。 如果此值为true，即使本地端不会发送音频数据，也将向远程端点发送音频数据。默认行为是仅在本地发送音频时才提供接收音频，否则不提供。
                    'OfferToReceiveVideo': true
                }
            }).then((sessionDescription) => {
                peerConnection.setLocalDescription(sessionDescription)
                console.log('创建SDP应答');
                sendSDP(sessionDescription)
            }).catch((err) => {
                console.error(`创建Answer失败：${err.message}`);
            })
        }

        function prepareNewConnection() {
            const pc_config = {
                "iceServers": []
            }
            let _peerConnection = null
            try {
                _peerConnection = new RTCPeerConnection(pc_config)
                console.log(_peerConnection.getSenders());
            } catch (err) {
                console.warn(`new RTCPeerConnection失败: ${err.message}`);
            }

            /**
             * 发送所有 ICE 候选给其它对等体
             */
            _peerConnection.onicecandidate = (evt) => {
                if (evt.candidate) {
                    console.log('存在 ICE 候选为：');
                    console.log(evt.candidate);
                    const candidateText = JSON.stringify({
                        type: 'candidate',
                        sdpMLineIndex: evt.candidate.sdpMLineIndex,
                        sdpMid: evt.candidate.sdpMid,
                        candidate: evt.candidate.candidate
                    })
                    console.log(`发送候选者信息：${candidateText}`);
                    socket.send(candidateText)
                }
            }

            const mediaStream = new MediaStream()
            remoteVideos[0].querySelector('video').srcObject = mediaStream
            console.log(_peerConnection.getSenders());

            //TODO: 暂时还不知道怎么分辨是添加轨道还是减少轨道
            _peerConnection.ontrack = (event) => {
                console.log('检测到远程媒体流发生变化');
                console.log(_peerConnection.getSenders());
                console.log(event);
                if (event.streams && event.streams[0]) {
                    console.log(event.streams);
                    for (const track of event.streams[0].getTracks()) {
                        mediaStream.addTrack(track)
                    }
                } else {
                    mediaStream.addTrack(event.track)
                    console.log(mediaStream.getTracks());
                }
            }

            // _peerConnection.onnegotiationneeded = () => {
            //     _peerConnection.createOffer({
            //         'mandatory': {
            //             'OfferToReceiveAudio': false, // 如果该值为false，即使本地端将发送音频数据，也不会提供远程端点发送音频数据。 如果此值为true，即使本地端不会发送音频数据，也将向远程端点发送音频数据。默认行为是仅在本地发送音频时才提供接收音频，否则不提供。
            //             'OfferToReceiveVideo': true
            //         }
            //     }).then((sessionDescription) => {
            //         peerConnection.setLocalDescription(sessionDescription)
            //         console.log('启动一个新的WebRTC去连接远程端点');
            //         sendSDP(sessionDescription)
            //     }).catch((err) => {
            //         console.error(`创建Offer失败：${err.message}`);
            //     })
            // }

            console.log('初始化连接轨道');
            for (const track of localStream.getTracks()) {
                _peerConnection.addTrack(track, localStream)
            }
            console.log(_peerConnection.getSenders());

            return _peerConnection
        }

        function sendSDP(sdp) {
            const sdpText = JSON.stringify(sdp)
            console.log(sdpText);
            socket.send(sdpText)
        }

        function setAnswer(evt) {
            if (!peerConnection) {
                console.error('PeerConnection不存在');
                return
            }
            peerConnection.setRemoteDescription(new RTCSessionDescription(evt))
        }

        function setCandidate(evt) {
            const candidate = new RTCIceCandidate({
                sdpMLineIndex: evt.sdpMLineIndex,
                sdpMid: evt.sdpMid,
                candidate: evt.candidate
            })
            console.log("接收到Candidate");
            peerConnection.addIceCandidate(candidate)
        }

        function stop() {
            peerConnection.close()
            peerConnection = null
            peerConnected = false
        }

        document.querySelector('#addDeviceStream').onclick = () => {
            const senders = peerConnection.getSenders()
            console.log(senders);
            senders.forEach(sender => {
                sender.replaceTrack(localStream.getTracks()[senders.indexOf(sender)]).then((res) => {
                    console.log(res);
                }).catch((err) => {
                    console.log(err);
                })
            });
            console.log(peerConnection.getSenders());
            peerConnection.getTransceivers().forEach((ts) => {
                console.log(ts);
            })
        }

        document.querySelector('#addDesktopStream').onclick = () => {
            const senders = peerConnection.getSenders()
            console.log(senders);
            senders.forEach(sender => {
                if (sender.track.kind === "video")
                    sender.replaceTrack(desktopStream.getTracks()[0]).then((res) => {
                        console.log(res);
                    }).catch((err) => {
                        console.log(err);
                    })
            });
            console.log(peerConnection.getSenders());
            peerConnection.getTransceivers().forEach((ts) => {
                console.log(ts);
            })
        }
    </script>
</body>

</html>